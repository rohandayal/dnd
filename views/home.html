<!DOCTYPE html>
<html style="height: 100%;">
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>This is it!</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css" integrity="sha384-wXznGJNEXNG1NFsbm0ugrLFMQPWswR3lds2VeinahP8N0zJw9VWSopbjv2x7WCvX" crossorigin="anonymous">
    </head>
    <body class="h-100">
        <div class="container-fluid h-100">
            <div class="row h-100">
                <div class="col-7 border rounded stage h-100 colorbg" style="padding: 0px;">
                    <div class="col-12 h-100 w-100" style="background-image: url('/images/room.png'); background-position: center center; background-size: cover; background-repeat: no-repeat;">
                        <div class="d-flex h-100 justify-content-center stage-contents w-100" style="text-align: center;">

                        </div>
                    </div>
                </div>
                <div class="col-5 interact h-100">
                    <div class="col-12" style="height: 48%;">
                        <h2>Interact</h2>
                        <div class="col-12 action-history h-75" style="overflow-y:auto;">

                        </div>
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" class="form-control" id="action-text" placeholder="Type your action here" />
                                <button class="btn btn-primary send-action"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="col-12" style="height: 48%;">
                        <h2>Chat</h2>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script> 
        <script lang="javascript">
            var actions = [];
            var interactions = [];
            const connection = new WebSocket('ws://localhost:8090');
            var username = '{{ username }}';
            var accesscode = '{{ accesscode }}';

            function setRoom(params) {
                $('.colorbg').animate({backgroundColor: params.background});
                for (index in params.objects) {
                    var obj = params.objects[index];
                    if(obj.hasOwnProperty("icon")) {
                        $('.stage-contents').append('<div class="object justify-content-center align-self-center rounded-circle" style="display: inline-block; text-align: center;"><image class="iconimage" src="../images/' + obj.icon + '" /><br />' + obj.name + '</div>');
                    } else {
                        $('.stage-contents').append('<div class="object justify-content-center align-self-center rounded-circle" style="display: inline-block; text-align: center;">' + obj.name + '</div>');
                    }
                }
            }

            function redrawInteractions() {
                $('.action-history').empty();
                for(var i=0; i<interactions.length; i++) {
                    $('.action-history').append('<div class="interaction align-bottom "><span class="badge badge-pill badge-primary" style="margin-right: 10px;">' + interactions[i].username + '</span>' + interactions[i].message + '</div>');
                }
            }

            function sendMessage(val) {
                for(var i=0; i<actions.length; i++) {
                    if(val.indexOf(actions[i]) > -1) {
                        console.log(actions[i]);
                        break;
                    }
                }
                connection.send({username: username, accesscode: accesscode, message: val});
                interactions.push({username: username, message: val});
                redrawInteractions();
                $('#action-text').val("");
            }

            $(document).ready(function() {
                $.get('/api/actions', function(getactions) {
                    actions = getactions;
                });
                $.get('/api/start', function(res) {
                    setRoom(res);
                });
                $('.send-action').on('click', function() {
                    sendMessage($('#action-text').val());
                });
                $('#action-text').on('keyup', function(event) {
                    if(event.keycode == 13 || event.which == 13) {
                        sendMessage($('#action-text').val());
                    }
                })
            });

            connection.onopen = () => {
                console.log("connected");
            }
            connection.onclose = () => {
                console.log("disconnected");
            }
            connection.onerror = (error) => {
                console.error('failed: ', error);
            }
            connection.onmessage = (event) => {
                console.log("received:", event.data);
                interactions.push(event.data);
                redrawInteractions();
            }
        </script>
        <style>
            .object {
                font-size: 15px;
                padding: 20px;
                /* border: 1px solid #333; */
                -moz-box-shadow: 0px 0px 5px 5px rgba(255,255,255,1);
                box-shadow: 0px 0px 5px 5px rgba(255,255,255,1);
                margin: 20px; 
                text-transform: uppercase;
                background: white;
                width: 100px;
                height: 100px;
            }
            .iconimage {
                width: 50px;
                height: 50px;
            }
        </style>
    </body>
</html>